<!DOCTYPE html>
<html>

<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<head>
<title>Edge Based Crowd Sensing</title>
</head>
<script type="text/javascript">

var measures = [];
var samples = 0;
var deviation = 0;
var xhr = new XMLHttpRequest();

function sma(){
	let sum = 0;

	measures.forEach( measure => {
		sum += Math.abs(measure.x) + Math.abs(measure.y) + Math.abs(measure.z);
	})

    return sum / measures.length;
}

function step(sma){
	let sum = 0;

	measures.forEach( measure => {
		sum += Math.pow(Math.abs(measure.x) + Math.abs(measure.y) + Math.abs(measure.z) - sma,2);
	});

	return Math.sqrt(sum / measures.length);
}

window.onbeforeunload = function(){
    xhr.open('GET', 'http://crowdsensing-env-1.eba-apr5bpbg.us-east-1.elasticbeanstalk.com/stop', true);
	xhr.send(null);
	sensor && sensor.stop();
    return false;
}
window.onload = function(){
	
	try{
		
		xhr.open('GET', 'http://crowdsensing-env-1.eba-apr5bpbg.us-east-1.elasticbeanstalk.com/start', true);
		xhr.send(null);
		sid = document.cookie.match('userId=([^;]*)')[1];
		if(sid!=null){
			document.getElementById("user").innerHTML = "User id: "+sid;
		}
		else{
			document.getElementById("user").innerHTML = "No session was created";
			return;
		}
		navigator.permissions.query({ name: 'accelerometer' }).then(result => {
			if (result.state === 'denied') {
				document.getElementById("error").innerHTML = 'Permission to use accelerometer sensor is denied.';
				return;
			}

			var sensor = new LinearAccelerationSensor({frequency: 1});

			sensor.start();

			sensor.onreading = () => {
				document.getElementById("x").innerHTML = "Acceleration along X-axis: " + sensor.x;
				document.getElementById("y").innerHTML = "Acceleration along Y-axis: " + sensor.y;
				document.getElementById("z").innerHTML = "Acceleration along Z-axis: " + sensor.z;

				measures.push({x: sensor.x, y: sensor.y, z: sensor.z});

				document.getElementById("samples").innerHTML = "Samples: "+measures.length+"/10";

				if(measures.length == 10){
					let sma = this.sma();	
					let step = this.step(sma);

					document.getElementById("sma").innerHTML = "SMA: "+sma;
					document.getElementById("step").innerHTML = "STEP: "+step;
					document.getElementById("status").innerHTML = "Status: "+ (step >= 1.5 ? "Moving" : "Stand still");
					
					measures = [];
				}
				
			}

			sensor.onerror = event => console.log(event.error.name, event.error.message);
		});
	}
	catch(e){
		let errorMsg = "";
		
		if (error.name === 'SecurityError') {
			errorMsg = 'Sensor construction was blocked by the Feature Policy.';
		} else if (error.name === 'ReferenceError') {
			errorMsg = 'Sensor is not supported by the User Agent.';
		} else {
			errorMsg = 'Error'
		}
		document.getElementById("error").innerHTML = errorMsg;
	}
}

</script>
<body>

<h1>User Activity Recognition</h1>
<p>A simple crowd-sensing model.</p>
<p id="user">User: </p>
<p id="status">Status:</p>
<p id="error"></p>
<ul>
  <li id="x">X:</li>
  <li id="y">Y:</li>
  <li id="z">Z:</li>
</ul> 
<p id="samples">Samples:</p>
<p id="sma"></p>
<p id="step"></p>

</body>
</html> 