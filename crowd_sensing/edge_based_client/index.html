<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<head>
	<title>Edge Based Crowd Sensing</title>
	<script type="text/javascript" type="module" src="../model.js"></script>
	<script type="text/javascript">

	var id = sessionStorage.getItem('crowdSensingId');

	window.onbeforeunload = function(){
		sensor && sensor.stop();
		socket.close();
    	return false;
	}
	window.onload = function(){
	
		try{
			if(!id){
				console.log("No id found on sessionStorage. Generating ...");
				id = generateId();
				sessionStorage.setItem('crowdSensingId', id);
			}
			// Create WebSocket connection.
			const socket = new WebSocket('wss://yvmf1zyr60.execute-api.us-east-1.amazonaws.com/prova');

			// Connection opened
			socket.addEventListener('open', (function (event) {
    			document.getElementById("received").innerHTML = "Connection to AWS established! With id: "+id;
			}).bind(this));

			// Listen for messages
			socket.addEventListener('message', (function (event) {
				document.getElementById("received").innerHTML = "Status ("+(event.data == 1 ? "moving" : "stand still")+") updated correctly.";
			}).bind(this));

			// Listen for messages
			socket.addEventListener('error', (function (event) {
				document.getElementById("received").innerHTML = "Received: "+event.data;
			}).bind(this));

			navigator.permissions.query({ name: 'accelerometer' }).then(result => {
				if (result.state === 'denied') {
					document.getElementById("error").innerHTML = 'Permission to use accelerometer sensor is denied.';
					return;
				}

				let sensor = new LinearAccelerationSensor({frequency: 1});

				var measures = [];

				sensor.start();

				sensor.onreading = () => ({
					document.getElementById("x").innerHTML = "Acceleration along X-axis: " + sensor.x;
					document.getElementById("y").innerHTML = "Acceleration along Y-axis: " + sensor.y;
					document.getElementById("z").innerHTML = "Acceleration along Z-axis: " + sensor.z;

					measures.push({x: sensor.x, y: sensor.y, z: sensor.z, ts: Date.now});

					document.getElementById("samples").innerHTML = "Samples: "+measures.length+"/10";

					if(measures.length == 10){
						let sma = this.sma(measures);	
						let steps = this.step(measures, sma);
						let status = getStatus(steps);

						document.getElementById("sma").innerHTML = "SMA: "+sma;
						document.getElementById("step").innerHTML = "STEP: "+steps;
						document.getElementById("status").innerHTML = "Status: "+ ( status == 1 ? "Moving" : "Stand still");
						socket.send(JSON.stringify({
							action: "store", 
							message:{
								ts: Date.now(), 
								id: id, 
								measures: measures, 
								steps: steps, 
								sma: sma, 
								status: status, 
								isCloudBased: false
							}
						}));

						measures = [];
					}
				}).bind(this);

				sensor.onerror = event => console.log(event.error.name, event.error.message);
			});
		}
		catch(e){
			let errorMsg = "";
		
			if (error.name === 'SecurityError') {
				errorMsg = 'Sensor construction was blocked by the Feature Policy.';
			} else if (error.name === 'ReferenceError') {
				errorMsg = 'Sensor is not supported by the User Agent.';
			} else {
				errorMsg = 'Error: '+e;
			}
			document.getElementById("error").innerHTML = errorMsg;
		}
	}
	</script>
</head>
<body>

<h1>User Activity Recognition</h1>
<p>A simple crowd-sensing model.</p>
<p id="status">Status:</p>
<p id="error"></p>
<ul>
  <li id="x">X:</li>
  <li id="y">Y:</li>
  <li id="z">Z:</li>
</ul> 
<p id="samples">Samples:</p>
<p id="sma"></p>
<p id="step"></p>
<p id="received"></p>

</body>
</html> 